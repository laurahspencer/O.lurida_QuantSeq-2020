---
title: "01-Importing-data-QuantSeq2020"
author: "Laura H Spencer"
date: "5/22/2020"
output: html_document
---

In this notebook I will import gene counts file that were generated by Bowtie --> FeatureCounts 

### Check working directory 

```{r}
getwd()
```

### Load libraries and source scripts 

```{r, message=FALSE, warning=FALSE, results=FALSE}
source("../references/biostats.R")

list.of.packages <- c("DESeq2", "RCurl", "tidyverse", "vegan", "pheatmap", "pastecs", 
                      "factoextra", "FactoMineR", "RColorBrewer", "tibble", "reshape2", "plotly") #add new libraries here 
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

# Load all libraries 
lapply(list.of.packages, FUN = function(X) {
  do.call("require", list(X)) 
})
```

### Import QuantSeq sample info, library/file names, and then join 

```{r}
sample.info <- read.csv("../raw-data/quantseq2020_key.csv", header=T, na.strings = NA) %>%
          mutate_at(vars(lane, temp.parent), as.factor) %>% 
          mutate_at(vars(RNA.conc, endpoint.RFU, bioan.mean.bp), as.numeric) %>%
          mutate(sample_stage=paste(sample, stage, sep="_"))

filenames <- data.frame(read.table("../qc-processing/featureCounts/filenames.txt", header = F, stringsAsFactors = F, fill = FALSE)) %>%
          dplyr::rename(filename = 1) %>%
          mutate(sample = as.character(gsub("_.*","", filename))) %>% 
          left_join(sample.info[c("sample", "sample_stage")])

# Fill in NA value on the "Undetermined" row  
filenames[filenames$filename == "Undetermined","sample_stage"] <- "Undetermined"

key <- full_join(sample.info, filenames)
save(key, file="../raw-data/key")
```

### Import counts matrix file as dataframe. 
```{r}
counts <- data.frame(read.table("../qc-processing/featureCounts/featurecounts-gene2kbdown.Rmatrix.txt", header = T, stringsAsFactors = F, fill = FALSE)) %>%
          column_to_rownames(var="Geneid") %>%
          rename_all(~as.character(filenames$sample_stage))
```

### Summarize counts and visualize (remove last column - that's undetermined counts)
```{r}
print(paste("Number of samples:", ncol(counts[,-ncol(counts)]), sep=" "))
print(paste("Total number of genes in dataframe:", prettyNum(nrow(counts[,-ncol(counts)]), big.mark = ","), sep=" "))
print(paste("Total counts, all samples:", prettyNum(sum(colSums(counts[,-ncol(counts)])), big.mark = ","), sep=" "))
#print(paste("Counts for", colnames(counts), ":",  prettyNum(colSums(counts), big.mark = ","), sep=" "))

#inspect total counts by sample
ggplotly(ggplot(data.frame(colSums(counts[,-ncol(counts)])) %>% dplyr::rename(count.total = 1) %>% rownames_to_column(var="sample"))  + geom_bar(aes(x=sample, y=count.total), stat = "identity") + ggtitle("Total count by sample") + 
             theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())) 
```

## NOTE: Samples 35 and 43 have very low counts, similar to sample 571 which was the no-tissue control, prepared alongside larval samples. Consider removing samples 35 & 43

## IMPORTANT NOTE: Should you wish to remove samples with very low counts, you can do so here 

```{r}
remove.list <- c("571_larvae", "Undetermined") #enter the samples you wish to remove here
counts <- counts[ , -which(names(counts) %in% remove.list)]
ncol(counts)
key <- key[ -which(key$sample_stage %in% remove.list), ]
nrow(key)
nrow(key) == ncol(counts) #should = TRUE.
```

### Transpose dataframe so each row = a sample (aka "objects"), and each column = genes (aka "variables") 
```{r}
counts.t <- t(counts) #transform data to have each sample a row, each column a gene 
```

### Save counts file, and transformed counts file 
```{r}
save(counts, file = "../results/gene-counts")
save(counts.t, file = "../results/gene-counts-trans")
```

